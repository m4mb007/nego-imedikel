<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-8">Rewards Management</h1>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-700">Total Wallets</h3>
      <p class="text-3xl font-bold text-blue-600"><%= @total_wallets %></p>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-700">Total Points</h3>
      <p class="text-3xl font-bold text-green-600"><%= @total_points %></p>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-700">Total Transactions</h3>
      <p class="text-3xl font-bold text-purple-600"><%= @total_transactions %></p>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-700">Points Earned</h3>
      <p class="text-3xl font-bold text-green-600">+<%= @total_credits %></p>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-700">Points Redeemed</h3>
      <p class="text-3xl font-bold text-red-600">-<%= @total_debits %></p>
    </div>
  </div>

  <!-- Configuration -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-xl font-semibold">Rewards Configuration</h2>
        <p class="text-sm text-gray-600 mt-1">You can also configure rewards in the main <a href="<%= admin_settings_path %>" class="text-blue-600 hover:text-blue-800 underline">Settings</a> page</p>
      </div>
      <%= link_to edit_admin_rewards_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Edit Configuration
      <% end %>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Points per RM1</label>
        <p class="text-lg font-semibold text-gray-900"><%= @config[:points_per_ringgit] %></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Redemption %</label>
        <p class="text-lg font-semibold text-gray-900"><%= @config[:redemption_percentage] %>%</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Points to RM Ratio</label>
        <p class="text-lg font-semibold text-gray-900"><%= @config[:points_to_ringgit_ratio] %>:1</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Min Redemption</label>
        <p class="text-lg font-semibold text-gray-900"><%= @config[:min_redemption_amount] %> points</p>
      </div>
    </div>
  </div>

  <!-- Top Users and Recent Transactions -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Top Users -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b">
        <h2 class="text-xl font-semibold">Top Users by Points</h2>
      </div>
      <div class="p-6">
        <% if @top_users.any? %>
          <div class="space-y-4">
            <% @top_users.each_with_index do |wallet, index| %>
              <div class="flex items-center justify-between py-2 border-b">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                    <span class="text-sm font-medium text-gray-600"><%= index + 1 %></span>
                  </div>
                  <div>
                    <p class="font-medium"><%= wallet.user.full_name %></p>
                    <p class="text-sm text-gray-600"><%= wallet.user.email %></p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-green-600"><%= wallet.points %> points</p>
                  <p class="text-sm text-gray-500">RM<%= (wallet.points / @config[:points_to_ringgit_ratio].to_f).round(2) %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500">No users with points yet</p>
        <% end %>
      </div>
    </div>

    <!-- Award Points Form -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b">
        <h2 class="text-xl font-semibold">Award Points</h2>
      </div>
      <div class="p-6">
        <%= form_with url: award_points_admin_rewards_path, method: :post, local: true do |form| %>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
              <%= form.select :user_id, 
                  User.all.map { |u| ["#{u.full_name} (#{u.email})", u.id] },
                  { prompt: "Choose a user..." },
                  { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" } %>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Points to Award</label>
              <%= form.number_field :amount, 
                  min: 1, 
                  step: 1,
                  class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" %>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
              <%= form.text_field :description, 
                  placeholder: "e.g., Bonus points for loyalty",
                  class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" %>
            </div>
            
            <%= form.submit "Award Points", class: "w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b">
        <h2 class="text-xl font-semibold">Recent Transactions</h2>
      </div>
      <div class="p-6">
        <% if @recent_transactions.any? %>
          <div class="space-y-4">
            <% @recent_transactions.each do |transaction| %>
              <div class="flex items-center justify-between py-2 border-b">
                <div>
                  <p class="font-medium"><%= transaction.reward_wallet.user.full_name %></p>
                  <p class="text-sm text-gray-600"><%= transaction.description %></p>
                  <p class="text-xs text-gray-500"><%= transaction.formatted_date %></p>
                </div>
                <div class="text-right">
                  <p class="font-medium <%= transaction.credit? ? 'text-green-600' : 'text-red-600' %>">
                    <%= transaction.formatted_amount %>
                  </p>
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    <%= transaction.credit? ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                    <%= transaction.transaction_type.titleize %>
                  </span>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500">No transactions yet</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
